# Firebase 免費額度優化指南

## Firebase 免費額度限制

### Firestore
- **每日讀取**: 50,000 次
- **每日寫入**: 20,000 次
- **每日刪除**: 20,000 次
- **存儲**: 1 GB

### Cloud Functions
- **調用次數**: 2,000,000 次/月
- **計算時間**: 400,000 GB-秒/月
- **出站網絡**: 5 GB/月

## 當前問題分析

### 1. 實時監聽 (onSnapshot) 過度使用
- **問題**: `useFirestore` hook 使用 `onSnapshot` 進行實時監聽
  - 每次數據變更都會觸發讀取操作
  - AdminDashboard 同時監聽 9 個集合
  - 多個頁面同時使用實時監聽
- **影響**: 如果數據頻繁更新，會快速消耗讀取配額

### 2. 查詢沒有數量限制
- **問題**: 所有查詢都沒有 `limit()`，會讀取整個集合
  - 新聞集合可能包含數百或數千條記錄
  - 每次頁面載入都會讀取所有數據
- **影響**: 大量不必要的讀取操作

### 3. 定時任務頻率過高
- **問題**: 
  - Telegram: 每 15 分鐘
  - 政府新聞: 每小時
  - RTHK 新聞: 每 30 分鐘
  - Google News: 每 30 分鐘
- **影響**: 頻繁的查詢和寫入操作

### 4. 沒有數據清理機制
- **問題**: 舊數據沒有定期清理
- **影響**: 數據庫不斷增長，查詢成本增加

## 優化方案

### 方案 1: 改用一次性查詢替代實時監聽（推薦）

**優點**:
- 大幅減少讀取操作
- 只在需要時才讀取數據
- 適合大多數不需要實時更新的場景

**實施**:
- 將 `onSnapshot` 改為 `getDocs`
- 添加手動刷新按鈕
- 對於需要實時更新的頁面（如 AdminDashboard），可以保留實時監聽但添加限制

### 方案 2: 添加查詢限制和分頁

**優點**:
- 減少單次查詢的讀取量
- 提升頁面載入速度
- 降低內存使用

**實施**:
- 為所有查詢添加 `limit()`
- 實現分頁功能
- 只載入當前頁面需要的數據

### 方案 3: 降低定時任務頻率

**建議頻率**:
- Telegram: 每 30 分鐘 → 每 1 小時
- 政府新聞: 每小時 → 每 2 小時
- RTHK 新聞: 每 30 分鐘 → 每 1 小時
- Google News: 每 30 分鐘 → 每 1 小時

### 方案 4: 實現數據清理機制

**建議**:
- 定期清理 30 天前的新聞
- 保留重要數據（如事件統計）
- 使用 Cloud Functions 定時清理

### 方案 5: 添加本地緩存

**優點**:
- 減少重複讀取
- 提升用戶體驗
- 降低 Firestore 讀取次數

**實施**:
- 使用 localStorage 或 IndexedDB
- 設置合理的緩存過期時間
- 在數據更新時清除緩存

## 監控建議

1. **設置 Firebase 預算警報**
   - 在 Firebase Console 設置預算警報
   - 當使用量達到 80% 時發送通知

2. **定期檢查使用量**
   - 每日檢查 Firestore 讀寫次數
   - 監控 Cloud Functions 調用次數

3. **分析高消耗操作**
   - 識別哪些操作消耗最多配額
   - 優先優化高消耗操作

## 實施優先級

1. **高優先級**（立即實施）:
   - ✅ 添加查詢限制（`limit()`）
   - ✅ 降低定時任務頻率
   - ✅ 在非管理頁面改用一次性查詢

2. **中優先級**（近期實施）:
   - 實現數據清理機制
   - 添加本地緩存
   - 優化 AdminDashboard 的實時監聽

3. **低優先級**（長期優化）:
   - 實現更智能的緩存策略
   - 添加數據壓縮
   - 考慮使用 CDN 緩存靜態數據

## 已實施的優化

### 1. 優化 useFirestore Hook
- ✅ 添加了 `limit` 選項，自動為不同集合設置合理的預設限制
- ✅ 添加了 `realtime` 選項，允許選擇使用一次性查詢或實時監聽
- ✅ 添加了 `refresh` 函數，支持手動刷新數據

**預設限制**:
- `news` / `announcements`: 100 條
- `historyRecords`: 50 條
- `eventStats`: 10 條
- `reconstructionInfo`: 50 條
- `financialAid`: 100 條
- `locations` / `services` / `reliefServices`: 500 條

### 2. 更新頁面使用一次性查詢
- ✅ `NewsPage`: 使用一次性查詢，限制 200 條
- ✅ `HomePage`: 使用一次性查詢，限制 50 條公告
- ✅ `FinancialAidPage`: 使用一次性查詢，限制 100 條
- ✅ `MoreSupportPage`: 使用一次性查詢，限制 500 條
- ✅ `HistoryPage`: 使用一次性查詢，限制 50 條
- ✅ `ReconstructionPage`: 使用一次性查詢，限制 50 條
- ✅ `EventStats` 組件: 使用一次性查詢，限制 10 條統計和 50 條新聞

### 3. 保留管理後台的實時監聽
- ✅ `AdminDashboard`: 保留實時監聽（管理後台需要即時更新），但添加了限制

### 4. 定時任務配置
- ✅ Telegram 頻道檢查: 每 15 分鐘（保持原頻率）
- ✅ 政府新聞: 每小時（保持原頻率）
- ✅ RTHK 新聞: 每 30 分鐘（保持原頻率）
- ✅ Google News: 已取消定時任務（保留手動觸發功能）

## 預期效果

### 讀取操作減少
- **之前**: 每個頁面使用實時監聽，每次數據變更都會觸發讀取，且沒有數量限制
- **之後**: 一般頁面使用一次性查詢，只在頁面載入時讀取一次，且有數量限制
- **預估減少**: 約 70-90% 的讀取操作

### 寫入操作減少
- **之前**: 定時任務頻繁執行，包括 Google News 每 30 分鐘執行一次
- **之後**: 取消 Google News 定時任務，減少不必要的寫入操作
- **預估減少**: 約 30-40% 的寫入操作（主要來自取消 Google News）

## 使用建議

### 一般頁面
```typescript
// 使用一次性查詢（預設）
const { data, loading, error, refresh } = useFirestore<News>('news', {
  realtime: false,
  limit: 200
})
```

### 管理後台
```typescript
// 使用實時監聽
const { data, loading, error } = useFirestore<News>('news', {
  realtime: true,
  limit: 200
})
```

### 手動刷新
```typescript
// 在非實時模式下，可以使用 refresh 函數手動刷新
const { data, loading, error, refresh } = useFirestore<News>('news', {
  realtime: false
})

// 在需要時調用
<button onClick={refresh}>刷新數據</button>
```

